{% load static %}

<html>

    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>

<head>
</head>

<body>
    <div class = "page-preview">

        <div class = "head">
            <img class = "logo" src = "{% static 'media/logo.png' %}" width=300 height=140>
            <div class = "description">
                <label class = "description-label"> 
                    Texflow generates an entity-relation flowchart from an english text. 
                    The generated flowchart can illustrate and even summarize the text after the user enters a summarization percentage.
                    The user can modify the automatically generated flowchart to make it more satisfying.
                    Texflow can help the user identify relations between entities in lengthy texts.  
                </label>
            </div> 
        </div>

        <form action = "" method = "POST">

            <div class = "input-text">
                <label class = "label1"> Text </label> <br> <br>
                <textarea class = "input-text-area" id="input-text" 
                name="input-text" cols="60" rows= "15" type="text" required= "required";>
                Enter your text here.
                </textarea>
                <button type = "button" class = "button1" id = "import-from-file"> Import From File </button>
            </div>

            <div class = "features">
                <div class = "feature">
                    <label class = "feature-description"> 
                        For a brief graphical entity-relation representation of the text:
                    </label>
                    <input type = "submit" name = "quick-and-brief" class = "button2" id = "quick-and-brief" value = "Quick & Brief">
                </div>
                
                <hr>

                <div class = "feature">
                    <label class = "feature-description"> 
                        For a graphical entity-relation representation of the text with a specified 
                        percentage of the text to be represented in the flowchart, 
                        specify or drag the slider below to specify the desired percentage and click on the button.
                    </label> <br>
                    <input id="amount" name= "amount" type="number" value="50" min="30" max="100" step = "1" class = "input-number" oninput="rangeInput.value=amount.value" />
                    <input  id="rangeInput" name= "rangeInput" type="range" min="30" max="100" step = "1" class = "slider" oninput="amount.value=rangeInput.value" />
                    <input type ="submit" name = "generate-flowchart" class = "button2" id = "generate-flowchart" value = "Generate Flowchart">
                </div>
                <hr>
            </div>
        </form>

        <div class = "flowchart-area">
            <label class = "label1"> Flowchart </label> <br> <br>
            <div id = "flowchart" class = "flowchart"> </div>
            <button class = "button1" id = "save-as-image"> Save As Image </button>
        </div>

        <div class = "features">
            <div class = "feature">
                <button class = "button3" id="disable-physics"> Disable Physics</button>
                <button class = "button3" id="enable-physics"> Enable Physics</button>
                <button class = "button3" id="merge-leaves"> Merge Leaves </button>
            </div>
            <hr>
            <div class = "feature-with-textarea">
                <label class = "feature-description"> 
                    To modify the entities in the flowchart, 
                    add or remove entities from the list below (keep them seperated by ',').
                    Then click on the "Submit Entities" button.
                </label> <br>
                <form action = "" method="POST">
                    <textarea id= "entities-list" name="entities-list" class= "large-textarea" type="text"> </textarea>
                    <textarea id = "hidden-input" name="hidden-input" style="display:none;" type="text"></textarea>
                    <input type = "submit" class = "button2" name = "submit-entities" id = "submit-entities" value = "Submit Entities">
                </form>
            </div>
            <hr>    
            <div class = "feature-with-textarea">
                <label class = "feature-description"> 
                    To highlight and print the path (representing the full relation) corresponding to 
                    an edge, select the edge and click on:
                </label> <br>
                <textarea readonly class= "large-textarea"> </textarea>
                <button class = "button2" id = "get-full-relation"> Get Full Relation </button>
            </div>
            <hr>
            <div class = "feature-with-textarea">
                <label class = "feature-description"> 
                    To highlight and print all paths between 2 entities, select them and click on:
                </label> <br>
                <textarea readonly class= "large-textarea"> </textarea>
                <button class = "button2" id = "get-all-paths"> Get All Paths </button>
            </div>
            <hr>
        </div>
    </div>
</body>
</html>

<style>
    .head {
        width: 100%;
        /*border: 3px solid rgb(255, 77, 100);*/
        padding:0;
    }
    .logo{
        border-collapse:collapse;
        position:relative;
        margin-left: 10%;
        margin-top: 4%;
        padding:0;
    }
    hr {
        background-color: #91acdf; 
        color:  #91acdf; 
        border-width: 0;
        height: 2px;
        position: relative;
    }
    .description {
        position:relative;
        margin-left: 10%;
        margin-right: 10%;
        margin-top: 1%;
        margin-bottom: 4%;
        padding:0;
    }
    .description-label{
        font-family: Arial, Helvetica, sans-serif;
        font-size: 14px;
        color:#00297A;
        font-style: italic;
        line-height: 24px;
    }
    .input-text{
        position:relative;
        margin-left: 10%;
        margin-right: 10%;
        margin-top: 1%;
        margin-bottom: 5%;
        padding:0;
    }
    .label1{
        font-family: Arial, Helvetica, sans-serif;
        font-size: 36px;
        color:#00297A;
        font-weight: bold;
        line-height: 50px;
        position:relative;
    }

    .input-text-area{
        font-family: Arial, Helvetica, sans-serif;
        font-size: 14px;
        color:#88a5dbaf;
        position:relative;
        resize:none; 
        border: 2px solid #91acdf; 
        padding: 0;
        margin:0;
        white-space: normal;
        width: 100%;
        height: 40%;
    }
    .button1{
        font-family: Arial, Helvetica, sans-serif;
        font-size: 20px;
        font-weight: bold;
        background-color:#00297A;
        color:#91acdf; 
        border: 2px solid #91acdf; 
        width: 100%;
        height: 7%;
        cursor:pointer;
    }
    .features{
        position:relative;
        margin-left: 10%;
        margin-right: 10%;
        margin-top: 1%;
        margin-bottom: 5%;
        padding:0;
    }
    .feature{
        height: 10%;
       /* border: 2px solid #91acdf; */
       margin-bottom: 3%;
       margin-top: 3%;
    }
    .feature-with-textarea{
        height: 20%;
        /* border: 2px solid #91acdf; */
        margin-bottom: 3%;
        margin-top: 3%;
    }
    .feature-description{
        font-family: Arial, Helvetica, sans-serif;
        font-size: 16px;
        font-weight: bold;
        color:#00297A; 
        display: block;
        width: 100%;
        height: 20%;
        line-height: 24px;

    }
    .button2{
        font-family: Arial, Helvetica, sans-serif;
        font-size: 20px;
        font-weight: bold;
        background-color:#00297A;
        color:#91acdf; 
        border: 2px solid #91acdf; 
        float:right;
        width: 20%;
        height: 50%;
        /*margin-right: 5%;*/
        margin-top: 2%;
        cursor:pointer;
    }
    .button2:active{
        background-color:#2358c2;
        color:#91acdf; 
        border: 2px solid #91acdf; 
    }
    .button1:active{
        background-color:#2358c2;
        color:#91acdf; 
        border: 2px solid #91acdf; 
    }
    .button3:active{
        background-color:#2358c2;
        color:#91acdf; 
        border: 2px solid #91acdf; 
    }
    .button3{
        font-family: Arial, Helvetica, sans-serif;
        font-size: 20px;
        font-weight: bold;
        background-color:#00297A;
        color:#91acdf; 
        border: 2px solid #91acdf; 
        float:left;
        width: 25%;
        height: 60%;
        margin-right: 4%;
        margin-left: 4%;
        cursor:pointer;
    }
    .flowchart-area{
        position:relative;
        margin-left: 10%;
        margin-right: 10%;
        margin-top: 1%;
        margin-bottom: 5%;
        padding:0;
    }
    .flowchart{
        position:relative;
        border:2px solid #91acdf; 
        width: 100%;
        height: 80%;
    }

    .large-textarea{
        resize: none;
        width: 70%;
        height: 60%;
        border: 2px solid #91acdf; 
        margin-top: 2%;
    }

    .slider {
        float:left;
        width: 60%; 
        height: 25px;
        background: #91acdf;
        outline: none; 
        -webkit-transition: .2s; 
        transition: opacity .2s;
        margin-top: 2.5%;
        margin-bottom: 1%;
        margin-left: 0;
        margin-right: 3%;
        
    }
    .input-number{
       /* float:right;*/
        width: 5%;
        font-size: 20px;
        font-weight: bold;
        color:#00297A; 
        margin-top: 2%;
    }
    div.vis-network div.vis-edit-mode button.vis-button.vis-edit.vis-edit-mode {
            color:rgb(13, 13, 112);
            background-color: white;
            border-color: white;
            text-align: center;
            font-size: 16pt;
            cursor: pointer
        }
        div.vis-network div.vis-edit-mode div.vis-label {
            font-size: 16pt;
            color: purple;
        }

        div.vis-network div.vis-manipulation button.vis-button.vis-add {
            color:rgb(13, 13, 112);
            background-color: white;
            border-color:rgb(13, 13, 112);
            text-align: center;
            font-size: 16pt;
            cursor: pointer
        }

        div.vis-network div.vis-manipulation div.vis-label {
            font-size: 16pt;
            color: black;
        }

        div.vis-network div.vis-manipulation div.vis-none {
            font-size: 16pt;
            color: black;  
        }
</style> 

<script> 
    var transaction = JSON.parse("{{general|escapejs}}");
    if(transaction["time"] == 1){
        var words = JSON.parse("{{mainwords|escapejs}}");
        var wordlist = document.getElementById('entities-list');
        wordlist.innerHTML = "";
        for (var x in words) {
                if (x != "0") {
                    wordlist.innerHTML += (x + '\n');
                }
        }

        var hide = document.getElementById('hidden-input');
        hide.innerHTML = words["0"];

        var recoverInput = document.getElementById('input-text');
        recoverInput.innerHTML = words["0"];
    }
    let data3 = {}
    let in_nodes = [];
    let in_edges = [];

    if(transaction["time"] <= 2){
        var data1 = JSON.parse("{{data1|escapejs}}"); 
        
        for (var x in data1) {
            if (x != "0") {
                var node = new Object();
                node.id = x;
                node.label = data1[x];
                in_nodes.push(node);
            }
        }

        data2 = JSON.parse("{{data2|escapejs}}"); 
        data3 = JSON.parse("{{data3|escapejs}}"); 

        for (var x in data2) {
            var edge = new Object();
            s = x.split('|');
            edge.from = s[0];
            edge.to = s[1];
            edge.relation = data2[x];
            in_edges.push(edge);
        }
        var recoverInput = document.getElementById('input-text');
        recoverInput.innerHTML = data1["0"];
    }

    var graph = {};
    var relations = {};
    var nodes = [];
    paths = {};
    parentPath = {};
    
    
    for (i = 0; i < in_nodes.length; i++){
        var node = new Object();
        node.id = in_nodes[i].id;
        node.label = in_nodes[i].label;

        nodes.push(node);
    }
    nodes = new vis.DataSet(nodes);


    var edges = [];
    for (i = 0; i < in_edges.length; i++){
        
        relKey = in_edges[i].from + "_" +  in_edges[i].to;  
        relations[relKey] = in_edges[i].relation;
        
        var edge = new Object();
        edge.from = in_edges[i].from;
        edge.to = in_edges[i].to;
        edge.label = in_edges[i].relation;

        edges.push(edge);

        if (! (in_edges[i].from in graph) ) {
            graph[(in_edges[i].from)] = [];
        }
        
        graph[in_edges[i].from].push(in_edges[i].to);

        if (! (in_edges[i].to in graph)) {
            graph[in_edges[i].to] = [];
        }
        graph[in_edges[i].to].push(in_edges[i].from); 
    }
    edges = new vis.DataSet(edges);
    
    var container = document.getElementById('flowchart');

    var data = {
        nodes: nodes,
        edges: edges
    };

    var options = 
    {
        width: '100%',
        length: '100%',
        navigation: true,
        smoothCurves: false,
        configurePhysics: true,
        physics: {
            enabled: true        
        },
        manipulation: {
            addNode: function(nodeData, callback){
                var inputNodeLabel = prompt("Please enter the label of the node");
                nodeData.label = inputNodeLabel;
                callback(nodeData);
            },
            addEdge: function(edgeData,callback) {
                var inputEdgeLabel = prompt("Please enter the label of the edge");
                edgeData.label = inputEdgeLabel;
                if (edgeData.from === edgeData.to) {
                    var r = confirm("Are you sure you want to connect the node to itself?");
                    if (r === true) {
                        callback(edgeData);
                    }
                }
                else {
                    callback(edgeData);
                }
            },

            editNode: function (data, callback) {
                var newNodeLabel = prompt("Please enter the new label of the selected node");
                data.label = newNodeLabel;
                callback(data);
            },

            editEdge: function (data, callback) {
                var newEdgeLabel = prompt("Please enter the new label of the selected edge");
                data.label = newEdgeLabel;
                callback(data);
            }
        },
        
        layout: {
            randomSeed: undefined,
            improvedLayout:true,
            clusterThreshold: 150,
            hierarchical: {
            enabled:false,
            levelSeparation: 200,
            nodeSpacing: 100,
            treeSpacing: 200,
            blockShifting: true,
            edgeMinimization: true,
            parentCentralization: true,
            direction: 'UD',        // UD, DU, LR, RL
            sortMethod: 'hubsize',  // hubsize, directed
            shakeTowards: 'leaves'  // roots, leaves
            }
    },
                
        edges: {
            width: 1.5,
            length: 300,
            style: 'line',
            color: {
                color: '#6ebfff', 
                highlight: '#0061fc'
            },
            font: {
                size: 12,
                color: '#00297A',
            },
            arrows:{
                to: {
                    enabled: true,
                    scaleFactor: 0.5,
                    type:"arrow"
                }
            },
        },
        nodes: {
            shape: 'box',
            color: {
                background: '#c4e5ff',
                border: '#6ebfff',
                highlight: {
                    border: '#0061fc',
                    background: '#80c7ff', //'#ffadbe',
                }
            },
            borderWidth: 2, 
            font: {
                size: 16,
                multi: true,
                align: 'center',
                color: '#00297A',
            },
            margin: { top: 10, right: 10, bottom: 10, left: 10 },
            heightConstraint: { minimum: 40 },
            widthConstraint: { minimum: 60 }
        },
    };

    var network = new vis.Network(container, data, options);
    
    for (edge in network.body.edges){
        key = edge;
        edgeLabel = network.body.edges[edge].options.label;
        value = network.body.edges[edge].options.from.toString() + "|" + network.body.edges[edge].options.to.toString() + "|" + edgeLabel + "|";

        parentPath[key] = data3[value];
        
        if (data3[value] in paths){
            paths[data3[value]].push(edge);
        }
        else {
            paths[data3[value]] = [edge];
        }
    }

    function isLeaf(nodeId){
        return graph[nodeId].length == 1;
    }

    function joinLeaves(){
        network.setData(data);

        parent = {}
        for(i=0; i < in_nodes.length; i++){
            if (isLeaf(in_nodes[i].id)) {
                parent[in_nodes[i].id] = (graph[in_nodes[i].id])[0];
            }
            else {
                parent[in_nodes[i].id] = in_nodes[i].id;
            } 
        }
        
        bullets = {}
        for (i = 0; i < in_nodes.length; i++) {
            if (!(parent[in_nodes[i].id] in bullets)){
                bullets[parent[in_nodes[i].id]] = "";
            }

            if ( parent[in_nodes[i].id] !== in_nodes[i].id){
                k1 = parent[in_nodes[i].id] + "_" + in_nodes[i].id;
                k2 = in_nodes[i].id + "_" + parent[in_nodes[i].id];
                
                line = ""
                if (k1 in relations){
                    line += ( parent[in_nodes[i].id]+ " " + relations[k1] + " " + in_nodes[i].id) + "\n";
                }

                if (k2 in relations){
                    line += ( in_nodes[i].id + " " + relations[k2] + " " + parent[in_nodes[i].id]) + "\n";
                }
                
                bullets[parent[in_nodes[i].id]] = bullets[parent[in_nodes[i].id]] + line;
                
            }
            
        }
        for(i = 0; i < in_nodes.length; i++) {

            clusterOptionsByData = {
                joinCondition: function(childOptions){
                    return parent[childOptions.id] === in_nodes[i].id; 
                },
                
                clusterNodeProperties: {
                    id: "Cluster:\n"+ in_nodes[i].label,
                    borderWidth: 2,
                    shape: "box",
                    font: {multi: "html", size: 14},
                    label: 
                        "<b>" + parent[in_nodes[i].id] + "</b>" + "\n\n" + bullets[parent[in_nodes[i].id]],
                    font: { color: "#eb2f87" }
                },
            }
            network.cluster(clusterOptionsByData);

        }
    }

    let mergeLeavesButton = document.getElementById("merge-leaves");
    mergeLeavesButton.onclick = function() {
        leavesCount = 0
        for(i=0; i < in_nodes.length; i++){
            if (isLeaf(in_nodes[i].id)){
                leavesCount++;
            }
        }
        joinLeaves();
    }

    network.on("selectNode", function(param){

        if (param.nodes.length === 1) {
            if (network.isCluster(param.nodes[0]) === true) {
                network.openCluster(param.nodes[0]);
            }
        }
    });  
    selectedEdge = "";

    network.on("selectEdge", function(param){
        if (param.edges.length === 1) {
            edgeId = param.edges[0];
            if(selectedEdge.localeCompare("") == 0){
                selectedEdge = edgeId;
            }
            else {
                selectedEdge = "";
                parPath = parentPath[edgeId];
                
                nodeFromSel = network.body.edges[edgeId].options.from.toString();
                nodeToSel = network.body.edges[edgeId].options.to.toString();

                newColor = '#6ebfff';
                newFontColor = '#00297A';
                newBackColor = '#c4e5ff';
                edges.update({id: edgeId, color:{color:newColor}, font: { color: newFontColor}});
                nodes.update({id: nodeFromSel, color:{border:newColor, background: newBackColor}, font: { color: newFontColor}});
                nodes.update({id: nodeToSel, color:{border:newColor, background: newBackColor}, font: { color: newFontColor}});


                for (i = 0 ; i < paths[parPath].length; i++) {
                    edge = (paths[parPath])[i];

                    nodeFrom = network.body.edges[edge].options.from.toString();
                    nodeTo = network.body.edges[edge].options.to.toString();

                    if (nodeFromSel.localeCompare(nodeFrom) === 0 && nodeToSel.localeCompare(nodeTo) === 0){
                        continue;
                    } 

                    else {
                        edges.update({id:edge, color:{color:newColor}, font: {  color: newFontColor}});
                        nodes.update({id: nodeFrom, color:{border:newColor, background: newBackColor}, font: {  color: newFontColor}});
                        nodes.update({id: nodeTo, color:{border:newColor, background: newBackColor}, font: {  color: newFontColor}});
                    }
                
                }
            
            }
        }
    });

    let disablePhysicsButton = document.getElementById("disable-physics");
    disablePhysicsButton.onclick = function() {
        network.setOptions( { physics: false } );
        return;
    }

    let enablePhysicsButton = document.getElementById("enable-physics");
    enablePhysicsButton.onclick = function() {
        network.setOptions( { physics: true } );
        return;
    }

    let getFullRealtionButton = document.getElementById("get-full-relation");
    getFullRealtionButton.onclick = function(){
        
        if (selectedEdge.localeCompare("") !== 0){
            edgeId = selectedEdge;
            parPath = parentPath[edgeId];
            
            nodeFromSel = network.body.edges[edgeId].options.from.toString();
            nodeToSel = network.body.edges[edgeId].options.to.toString();

            newColor = '#c400b4'; //'#ff667d'; //'#eb69ff'
            newFontColor = '#8c0081';
            newBackColor = '#ffc7fb';
            if(network.body.edges[edgeId].options.color.color === newColor) {
                return;
            } 
            
            edges.update({id: edgeId, color:{color:newColor}, font: { color: newFontColor }});
            nodes.update({id: nodeFromSel, color:{border:newColor, background: newBackColor}, font: { color: newFontColor  }});
            nodes.update({id: nodeToSel, color:{border:newColor, background: newBackColor}, font: {color: newFontColor  }});

            for (i = 0 ; i < paths[parPath].length; i++) {
                edge = (paths[parPath])[i];

                nodeFrom = network.body.edges[edge].options.from.toString();
                nodeTo = network.body.edges[edge].options.to.toString();

                if (nodeFromSel.localeCompare(nodeFrom) === 0 && nodeToSel.localeCompare(nodeTo) === 0){
                    continue;
                } 

                edges.update({id: edge, color:{color:newColor}, font: { color: newFontColor}});
                nodes.update({id: nodeFrom, color:{border:newColor, background: newBackColor}, font: { color: newFontColor }});
                nodes.update({id: nodeTo, color:{border:newColor, background: newBackColor}, font: { color: newFontColor}});
            
            }
        }
    }

</script>
